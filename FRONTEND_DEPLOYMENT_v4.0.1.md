# D√©ploiement Frontend v4.0.1 sur AWS

## Vue d'ensemble

Ce document d√©taille le processus de d√©ploiement de la version v4.0.1 du frontend Harena sur AWS EC2.

## Changements de la version v4.0.1

### Am√©liorations de l'interface
- **Sidebar unifi√©e** : La sidebar de conversation (historique des messages) est d√©sormais fixe sur toutes les pages
- **Suppression de la navigation redondante** : Retrait de l'ancienne sidebar de navigation
- **Dashboard utilisateur am√©lior√©** :
  - Suppression de la carte "Informations du profil" redondante
  - D√©placement de la section "Statistiques cl√©s" apr√®s les m√©triques financi√®res
  - Mise en page horizontale du "R√©sum√© budg√©taire" pour une meilleure lisibilit√©
- **Correction de bug** : R√©solution du probl√®me de page blanche sur `/configuration` (useState ‚Üí useEffect)

### Modifications techniques
- Refactorisation de `ConversationSidebar.tsx` pour rendre les props optionnels
- Consolidation de tous les routes sous `MainLayout`
- Suppression de `ChatLayout` devenu obsol√®te
- Am√©lioration de la navigation mobile

## Pr√©requis

### 1. Configuration AWS
- **Instance EC2** : `i-0011b978b7cea66dc` (t3.small)
- **IP publique** : `63.35.52.216`
- **AWS CLI** configur√© avec les bonnes permissions SSM
- **Acc√®s SSM** √† l'instance EC2

### 2. V√©rifications avant d√©ploiement
```bash
# V√©rifier la connexion AWS
aws sts get-caller-identity

# V√©rifier l'acc√®s SSM √† l'instance
aws ssm describe-instance-information \
  --instance-ids i-0011b978b7cea66dc
```

### 3. √âtat des repositories Git

#### Backend (harena/)
- Tag actuel : `v6.1.2`
- Modifications √† commit :
  - `docker-compose.aws.yml` (correction du port frontend 8080:80)
  - `update-frontend-aws.sh` (nouveau script de d√©ploiement)

#### Frontend (harena_front/)
- Tag : `v4.0.1` ‚úÖ (d√©j√† cr√©√© et push√©)
- D√©p√¥t s√©par√© avec son propre remote Git

## Modifications de configuration

### docker-compose.aws.yml

**Corrections effectu√©es** :
```yaml
frontend:
  build:
    context: ./harena_front
    dockerfile: Dockerfile  # Utilise Nginx pour la production
    args:
      VITE_USER_SERVICE_URL: /api/v1
      VITE_SEARCH_SERVICE_URL: /api/v1
      VITE_METRIC_SERVICE_URL: /api/v1
      VITE_CONVERSATION_SERVICE_URL: /api/v3
      VITE_BUDGET_PROFILING_API_URL: /api/v1/budget  # ‚úÖ Corrig√©
  ports:
    - "8080:80"  # ‚úÖ Corrig√© (√©tait 5173:5173)
  healthcheck:
    test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]  # ‚úÖ Port 80
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
```

**Explications** :
- Le Dockerfile du frontend utilise une build multi-stage : Node (builder) + Nginx (production)
- Le frontend sert les assets via Nginx sur le port 80 (standard HTTP)
- Le port externe 8080 permet d'acc√©der au frontend sans conflit avec le Nginx reverse proxy principal

### nginx/conf.d/harena.conf

**V√©rification effectu√©e** : Configuration correcte ‚úÖ

```nginx
# Le proxy_pass pointe correctement vers le service frontend
location / {
    proxy_pass http://frontend;  # R√©sout vers frontend:80 par d√©faut
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    # ... autres headers
}
```

## Processus de d√©ploiement

### M√©thode 1 : Script automatis√© (Recommand√©)

#### √âtape 1 : Commit des changements backend
```bash
cd ~/Projets/harena

# Ajouter les fichiers modifi√©s
git add docker-compose.aws.yml update-frontend-aws.sh FRONTEND_DEPLOYMENT_v4.0.1.md

# Commit avec message descriptif
git commit -m "feat(deployment): Add frontend v4.0.1 deployment configuration and script

- Fix docker-compose.aws.yml frontend port mapping (8080:80)
- Fix healthcheck to use port 80 instead of 5173
- Correct VITE_BUDGET_PROFILING_API_URL to /api/v1/budget
- Add update-frontend-aws.sh script for automated frontend deployment
- Add FRONTEND_DEPLOYMENT_v4.0.1.md documentation

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# Tag et push
git tag v6.1.3
git push origin main
git push origin v6.1.3
```

#### √âtape 2 : Ex√©cuter le script de d√©ploiement
```bash
cd ~/Projets/harena

# Rendre le script ex√©cutable
chmod +x update-frontend-aws.sh

# Lancer le d√©ploiement
./update-frontend-aws.sh
```

Le script effectue automatiquement :
1. ‚úÖ V√©rification de l'√©tat actuel du frontend
2. ‚úÖ Pull du code frontend depuis Git (tag v4.0.1)
3. ‚úÖ Mise √† jour de docker-compose.aws.yml
4. ‚úÖ Build du nouveau frontend (3-5 minutes)
5. ‚úÖ Arr√™t de l'ancien frontend
6. ‚úÖ D√©marrage du nouveau frontend
7. ‚úÖ Tests de v√©rification

### M√©thode 2 : D√©ploiement manuel via SSH

Si vous pr√©f√©rez contr√¥ler chaque √©tape :

```bash
# Connexion SSH
export EC2_IP=63.35.52.216
export EC2_USER=ec2-user
export SSH_KEY=~/.ssh/harena-aws.pem

ssh -i $SSH_KEY $EC2_USER@$EC2_IP

# Une fois connect√© sur l'EC2
cd ~/harena

# 1. Pull du backend (docker-compose.aws.yml mis √† jour)
git pull origin main
git checkout v6.1.3

# 2. Pull du frontend
cd harena_front
git fetch --tags
git checkout v4.0.1
git pull origin main
cd ..

# 3. Build du frontend
docker-compose -f docker-compose.aws.yml build --no-cache frontend

# 4. Red√©marrage du frontend
docker-compose -f docker-compose.aws.yml stop frontend
docker-compose -f docker-compose.aws.yml rm -f frontend
docker-compose -f docker-compose.aws.yml up -d frontend

# 5. V√©rification
docker-compose -f docker-compose.aws.yml ps frontend
docker-compose -f docker-compose.aws.yml logs -f frontend
```

## V√©rification post-d√©ploiement

### 1. V√©rifier l'√©tat des containers

Via SSM :
```bash
aws ssm send-command \
  --instance-ids i-0011b978b7cea66dc \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["cd ~/harena && docker-compose -f docker-compose.aws.yml ps"]' \
  --output text
```

Via SSH :
```bash
ssh -i ~/.ssh/harena-aws.pem ec2-user@63.35.52.216
cd ~/harena
docker-compose -f docker-compose.aws.yml ps
```

**R√©sultat attendu** :
```
NAME                                 STATUS          PORTS
harena-frontend-1                    Up (healthy)    0.0.0.0:8080->80/tcp
```

### 2. Tester l'acc√®s au frontend

#### Test depuis votre machine locale
```bash
# Test du health check du reverse proxy Nginx
curl http://63.35.52.216/health
# Attendu : OK

# Test de la page d'accueil du frontend
curl -I http://63.35.52.216:8080/
# Attendu : HTTP/1.1 200 OK

# Test via le reverse proxy (acc√®s normal)
curl -I http://63.35.52.216/
# Attendu : HTTP/1.1 200 OK
```

#### Test dans le navigateur
- **Frontend direct** : http://63.35.52.216:8080
- **Via reverse proxy** : http://63.35.52.216
- **Grafana** : http://63.35.52.216:3033

### 3. V√©rifier les logs

```bash
# Logs du frontend
docker-compose -f docker-compose.aws.yml logs -f frontend

# Logs du reverse proxy Nginx
docker-compose -f docker-compose.aws.yml logs -f nginx
```

**Logs normaux attendus** :
```
frontend-1  | /docker-entrypoint.sh: Launching /docker-entrypoint.d/40-envsubst-on-templates.sh
frontend-1  | /docker-entrypoint.sh: Configuration complete; ready for start up
```

### 4. Tests fonctionnels

Une fois le frontend accessible, tester :

‚úÖ **Pages principales** :
- [ ] Login / Register
- [ ] Chat (avec sidebar de conversation)
- [ ] Dashboard utilisateur
- [ ] Budget Profiling
- [ ] Configuration

‚úÖ **Nouvelle interface** :
- [ ] La sidebar de conversation est visible sur toutes les pages
- [ ] Le menu mobile fonctionne (bouton hamburger)
- [ ] Le dashboard affiche le layout horizontal
- [ ] La page Configuration se charge sans erreur

‚úÖ **APIs** :
- [ ] Connexion utilisateur fonctionne
- [ ] R√©cup√©ration des m√©triques financi√®res
- [ ] Chat avec l'assistant IA
- [ ] Sauvegarde des pr√©f√©rences utilisateur

## Monitoring

### Grafana
- **URL** : http://63.35.52.216:3033
- **Identifiants** : admin / HarenaAdmin2024!

**Dashboards √† surveiller** :
- Docker Container Metrics
- Nginx Access Logs
- Application Performance

### Logs centralis√©s (Loki)
```bash
# Via CLI (sur l'EC2)
docker-compose -f docker-compose.aws.yml logs -f frontend | grep -i error
```

## Rollback en cas de probl√®me

Si le d√©ploiement √©choue, revenir √† la version pr√©c√©dente :

```bash
cd ~/harena/harena_front

# 1. Revenir au tag pr√©c√©dent (√† adapter selon votre historique)
git checkout v4.0.0

# 2. Rebuild
cd ~/harena
docker-compose -f docker-compose.aws.yml build --no-cache frontend

# 3. Red√©marrer
docker-compose -f docker-compose.aws.yml up -d frontend

# 4. V√©rifier
docker-compose -f docker-compose.aws.yml ps frontend
docker-compose -f docker-compose.aws.yml logs frontend
```

## Troubleshooting

### Probl√®me 1 : Le frontend ne d√©marre pas

**Sympt√¥mes** :
```
frontend-1  | exited with code 1
```

**Solutions** :
```bash
# V√©rifier les logs d√©taill√©s
docker-compose -f docker-compose.aws.yml logs frontend

# V√©rifier que le build s'est bien pass√©
docker images | grep frontend

# Rebuild complet
docker-compose -f docker-compose.aws.yml build --no-cache frontend
docker-compose -f docker-compose.aws.yml up -d frontend
```

### Probl√®me 2 : Page blanche dans le navigateur

**Sympt√¥mes** :
- Le container est UP mais la page ne se charge pas
- Console browser : erreurs de connexion aux APIs

**Solutions** :
```bash
# 1. V√©rifier les variables d'environnement du build
docker-compose -f docker-compose.aws.yml config | grep -A 10 frontend

# 2. V√©rifier le fichier nginx.conf du frontend
docker-compose -f docker-compose.aws.yml exec frontend cat /etc/nginx/conf.d/default.conf

# 3. Tester les APIs backend
curl http://localhost/api/v1/health
curl http://localhost/api/v3/health
```

### Probl√®me 3 : Erreur 502 Bad Gateway

**Sympt√¥mes** :
```
502 Bad Gateway
nginx/1.24.0
```

**Solutions** :
```bash
# 1. V√©rifier que le frontend √©coute sur le bon port
docker-compose -f docker-compose.aws.yml exec frontend netstat -tlnp

# 2. V√©rifier la configuration du reverse proxy
docker-compose -f docker-compose.aws.yml exec nginx nginx -t

# 3. Red√©marrer le reverse proxy
docker-compose -f docker-compose.aws.yml restart nginx
```

### Probl√®me 4 : M√©moire insuffisante

**Sympt√¥mes** :
```
Build failed: Cannot allocate memory
```

**Solutions** :
```bash
# V√©rifier l'utilisation m√©moire
free -h

# Nettoyer les images inutilis√©es
docker system prune -a

# Augmenter le swap si n√©cessaire (d√©j√† configur√© √† 2GB)
sudo swapon -s
```

## Architecture du d√©ploiement

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Internet                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   EC2 Instance   ‚îÇ
              ‚îÇ  63.35.52.216    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                             ‚îÇ
          ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Port 80        ‚îÇ         ‚îÇ  Port 8080       ‚îÇ
‚îÇ  Nginx Reverse  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Frontend        ‚îÇ
‚îÇ  Proxy          ‚îÇ         ‚îÇ  (Nginx + React) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚îÇ Proxy vers...
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ /api/v1/users ‚Üí user_service:3000
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ /api/v1/search ‚Üí search_service:3001
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ /api/v1/metrics ‚Üí metric_service:3002
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ /api/v3/ ‚Üí conversation_service:3005
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ /api/v1/budget ‚Üí budget_profiling_service:3006
```

## Checklist de d√©ploiement

### Avant le d√©ploiement
- [ ] Code frontend committ√© et tagu√© (v4.0.1) ‚úÖ
- [ ] Configuration docker-compose.aws.yml mise √† jour ‚úÖ
- [ ] Script de d√©ploiement cr√©√© ‚úÖ
- [ ] Documentation √† jour ‚úÖ
- [ ] AWS CLI configur√©
- [ ] Acc√®s SSM v√©rifi√©

### Pendant le d√©ploiement
- [ ] Backup de l'√©tat actuel (optionnel)
- [ ] Ex√©cution du script update-frontend-aws.sh
- [ ] Surveillance des logs en temps r√©el
- [ ] Temps de build : ~3-5 minutes

### Apr√®s le d√©ploiement
- [ ] Container frontend UP et healthy
- [ ] Frontend accessible sur le port 8080
- [ ] Frontend accessible via reverse proxy (port 80)
- [ ] Tests fonctionnels pass√©s
- [ ] Monitoring Grafana v√©rifi√©
- [ ] Pas d'erreur dans les logs

## Points d'attention

### 1. Repositories s√©par√©s
- **Backend** : `~/Projets/harena/` - Contient docker-compose.aws.yml et scripts de d√©ploiement
- **Frontend** : `~/Projets/harena/harena_front/` - Sous-dossier avec son propre d√©p√¥t Git

Sur l'EC2, la structure est :
```
~/harena/
‚îú‚îÄ‚îÄ docker-compose.aws.yml
‚îú‚îÄ‚îÄ harena_front/  (clone Git s√©par√©)
‚îÇ   ‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ user_service/
‚îú‚îÄ‚îÄ conversation_service_v3/
‚îî‚îÄ‚îÄ ...
```

### 2. Configuration Nginx du frontend

Le frontend utilise un Dockerfile multi-stage :
1. **Stage 1** : Build avec Node.js et Vite
2. **Stage 2** : Serve avec Nginx

Le fichier `nginx.conf` du frontend doit rediriger toutes les routes vers `index.html` pour le routing React :
```nginx
location / {
    root /usr/share/nginx/html;
    try_files $uri $uri/ /index.html;
}
```

### 3. Variables d'environnement

Les variables `VITE_*` sont inject√©es au moment du **build** (pas au runtime) :
- `VITE_USER_SERVICE_URL=/api/v1`
- `VITE_SEARCH_SERVICE_URL=/api/v1`
- `VITE_METRIC_SERVICE_URL=/api/v1`
- `VITE_CONVERSATION_SERVICE_URL=/api/v3`
- `VITE_BUDGET_PROFILING_API_URL=/api/v1/budget`

Ces URLs relatives permettent au frontend de communiquer avec les APIs via le reverse proxy Nginx.

## Support et contacts

- **Documentation principale** : `DEPLOYMENT.md`
- **Infrastructure AWS** : `AWS_INFRASTRUCTURE.md`
- **Monitoring** : Grafana @ http://63.35.52.216:3033

---

**Version** : 1.0.0
**Date** : 2025-10-27
**Auteur** : Claude Code
**Frontend Version** : v4.0.1
