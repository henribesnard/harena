{
  "template_name": "analysis_breakdown",
  "description": "Analyse de répartition par catégorie, marchand ou autre dimension",
  "target_intention": "ANALYSIS_INSIGHTS.breakdown",
  "parameters": {
    "user_id": "{{user_id}}",
    "filters": {
      "date": "{{date_range}}",
      "transaction_type": "{{transaction_type}}"
    },
    "aggregations": {
      "breakdown_analysis": {
        "aggs": {
          "by_category": {
            "terms": {
              "field": "category_name.keyword",
              "size": "{{breakdown_size}}"
            },
            "aggs": {
              "category_total": {
                "sum": {
                  "field": "amount_abs"
                }
              },
              "category_count": {
                "value_count": {
                  "field": "transaction_id"
                }
              },
              "category_avg": {
                "avg": {
                  "field": "amount_abs"
                }
              }
            }
          },
          "by_merchant": {
            "terms": {
              "field": "merchant_name.keyword",
              "size": "{{breakdown_size}}"
            },
            "aggs": {
              "merchant_total": {
                "sum": {
                  "field": "amount_abs"
                }
              },
              "merchant_count": {
                "value_count": {
                  "field": "transaction_id"
                }
              }
            }
          }
        }
      }
    },
    "aggregation_only": true,
    "page_size": 1
  },
  "parameter_mappings": {
    "user_id": {
      "required": true,
      "type": "integer",
      "source": "context.user_id"
    },
    "date_range": {
      "required": false,
      "type": "object",
      "source": "entities.periode_temporelle"
    },
    "transaction_type": {
      "required": false,
      "type": "string",
      "source": "entities.transaction_type.transaction_type",
      "default": "debit"
    },
    "breakdown_size": {
      "required": false,
      "type": "integer",
      "source": "entities.top_n",
      "default": 20,
      "min": 5,
      "max": 100
    }
  },
  "aggregation_selection": {
    "dimension_based": {
      "category": ["by_category"],
      "merchant": ["by_merchant"],
      "both": ["by_category", "by_merchant"]
    }
  },
  "response_processing": {
    "extract_aggregations": true,
    "calculate_percentages": true,
    "format_currency": "EUR"
  },
  "optimizations": {
    "cache_duration": "10m",
    "elasticsearch_routing": "user_id"
  }
}